# サーバー構築ハンズオン 第3回 DNSサーバーで遊ぼう

## 目的

インターネットの根幹を成す技術のひとつであるDNS。ところがDNSの仕組みについて、よくわかってない開発者も多いようです。今回はDNSサーバーを実際に立ててみることで、DNSに触れてみましょう。ただしBINDは色々めんどいんでUnboundで!

## 事前準備

ハンズオン用ネットワークに(ブリッジで)繋がる仮想マシンを用意してください。手元のノートPCにVirtualBoxをインストールするのが一番簡単でしょう。VMが用意できない場合は事前に講師にお知らせください。

仮想マシンにUbuntu 16.04をインストールし、固定IPアドレスを振っておいてください。使ってよいIPアドレスは講師に問い合わせてください。

なおインストール時にtaskselでインストールするものは「standard system utilites」と「OpenSSH server」のみです。

## アジェンダ

1. Unboundのインストール
1. キャッシュサーバーとして動かす
1. クエリログとキャッシュを確認する
1. ローカルデータを挿入してみる
1. 浸透言うな
1. 毒入れ

## ハンズオン

### Unboundのインストール

`unbound`パッケージをインストールします。

(unboundパッケージのインストール)
```
$ sudo apt install unbound
```

これだけで自動的にunboundが起動し、`127.0.0.1`の53番ポートをlistenしはじめます。なお8953番ポートは`unbound-control`が使う、管理用のポートです。

(unbound起動後のポートの状態)
```
$ sudo ss -lntp | grep unbound
LISTEN     0      5                 127.0.0.1:8953                     *:*      users:(("unbound",17014,8))
LISTEN     0      5                 127.0.0.1:53                       *:*      users:(("unbound",17014,6))
LISTEN     0      5                       ::1:8953                    :::*      users:(("unbound",17014,7))
LISTEN     0      5                       ::1:53                      :::*      users:(("unbound",17014,4))
```

### キャッシュサーバーとして動かす

Ubuntuでは`resolvconf`によって`/etc/resolv.conf`が自動生成されます。そのため`resolv.conf`を直接書き換えることはせず、使用するネームサーバーは`/etc/network/interfaces`内の`dns-nameservers`オプションで指定する必要があります。

そのためUbuntuのUnboundは`resolvconf`と連携し、起動するとそのサーバーが自分自身で名前解決をするよう、`/etc/resolv.conf`を書き換えます。また元々`resolv.conf`内で指定されていた`nameserver`は、Unboundの`forward`に追加します。

(unbound起動前後でのresonv.confの変化)
```
$ sudo service unbound stop
$ cat /etc/resolv.conf
nameserver 8.8.8.8
$ sudo service unbound start
$ cat /etc/resolv.conf
nameserver 127.0.0.1
```

これでDNSキャッシュサーバーとして動作するようになりました。しかし`127.0.0.1`しかlistenしていないことからわかるように、外部からのクエリには応答できません。そこでLAN内から使えるよう設定を変更します。

Unboundの設定ファイルは`/etc/unbound/unbound.conf`ですが、この中身は以下のようになっており、実際の設定は`unbound.conf.d`以下に分割して置かれた`*.conf`ファイルから読み込むようになっています。

(/etc/unbound/unbound.conf)
```
include: "/etc/unbound/unbound.conf.d/*.conf"
```

サーバーの基本的な設定を`/etc/unbound/unbound.conf.d/server.conf`として作成します。以下の内容を記述してください。これは`0.0.0.0`でlistenし、自分自身とLAN(192.168.7.0/24)からのクエリを許可するという意味です。

(/etc/unbound/unbound.conf.d/server.conf)
```
server:
    interface: 0.0.0.0
    access-control: 127.0.0.1/32 allow
    access-control: 192.168.7.0/24 allow
```

Unboundを再起動します。

```
$ sudo service unbound restart
```

手元のPCから、`dig`でUnboundにクエリを投げてみましょう。

```
$ dig google.com @unboundのIPアドレス
```

### クエリログとキャッシュを確認する

(あとでかく)

### ローカルデータを挿入してみる

社内や家庭内でローカルな名前解決をする際、(⁠local.などのサブドメインをつけず)インターネット上に公開しているドメインと同じドメインを使いたいと思うことがあります。とはいえ、インターネット上にある権威サーバーに、ローカルIPアドレスを返すレコードを登録するわけにもいきません。

ある一つのドメインの中で、ローカルな名前はローカル内だけで解決し、かつインターネット上に公開している名前は本来の権威サーバーにクエリーを投げて解決するということができればよさそうです。これが実現できると、グローバルIPとローカルIPを両方持つようなサーバーは、家庭内からはローカルIPを返し、インターネット越しにはグローバルIPを返すというようなこともできます。

Unboundにはlocal-data(およびlocal-zoneのtransparent)という機能があり、この要求を実現することができます⁠。


### 浸透言うな

登録したDNSレコードが実際に引けるようになるまで24時間から48時間かかる……これを浸透待ちといいます……のようなデマを流す人がいます。世間で言われているDNSの浸透という誤解の正体を説明します。

(あとでかく)

### 毒入れ

DNSキャッシュポイゾニング攻撃の仕組みについて解説します。またTTLとカミンスキーアタックについても解説します。

(あとでかく)
